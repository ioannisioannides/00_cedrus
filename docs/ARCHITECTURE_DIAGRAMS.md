# Cedrus Architecture Diagrams

## System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         CLIENT LAYER                             │
│                    (Web Browsers, Mobile Apps)                   │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                      PRESENTATION LAYER                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   Views      │  │  Templates  │  │    Forms     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                       SERVICE LAYER                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ AuditService │  │FindingService│  │  OrgService  │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                       WORKFLOW LAYER                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │AuditWorkflow │  │FindingWorkflow│  │ CertWorkflow  │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                      REPOSITORY LAYER                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │AuditRepo     │  │FindingRepo   │  │  OrgRepo      │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                        DOMAIN LAYER                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │    Models     │  │   Managers   │  │  Querysets   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                    INFRASTRUCTURE LAYER                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Permissions │  │    Events    │  │   Storage    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                        DATA LAYER                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  PostgreSQL  │  │  File Store  │  │    Cache     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└──────────────────────────────────────────────────────────────────┘
```

## Trunk & Branches Architecture

```
                    ┌─────────────────────┐
                    │   TRUNK (Core)      │
                    ├─────────────────────┤
                    │                     │
                    │  • Organization     │
                    │  • Site             │
                    │  • Standard         │
                    │  • Certification    │
                    │                     │
                    │  • Permissions      │
                    │  • Events           │
                    │  • Storage          │
                    │  • Notifications    │
                    └──────────┬──────────┘
                               │
                ┌──────────────┼──────────────┐
                │              │              │
        ┌───────▼──────┐ ┌─────▼─────┐ ┌─────▼─────┐
        │   Accounts   │ │  Audits    │ │   Risk    │
        │   (Trunk)    │ │  (Branch)  │ │  (Branch) │
        └──────────────┘ └────────────┘ └───────────┘
                               │
                ┌──────────────┼──────────────┐
                │              │              │
        ┌───────▼──────┐ ┌─────▼─────┐ ┌─────▼─────┐
        │   Internal   │ │ Documents  │ │ Compliance│
        │   Audits     │ │  (Branch)  │ │  (Branch) │
        │   (Branch)   │ └────────────┘ └───────────┘
        └──────────────┘
```

## Module Dependency Graph

```
┌─────────────┐
│   Trunk     │ (No dependencies)
└──────┬──────┘
       │
       ├──────────────┐
       │              │
┌──────▼──────┐  ┌────▼──────┐
│  Accounts   │  │  Audits   │
│  (Trunk)    │  │  (Branch) │
└─────────────┘  └───────────┘
       │              │
       │              │
       └──────┬───────┘
              │
       ┌──────▼──────┐
       │    Risk     │
       │  (Branch)   │
       └─────────────┘
              │
       ┌──────▼──────┐
       │ Documents   │
       │  (Branch)   │
       └─────────────┘
```

**Dependency Rules:**

- Trunk has no dependencies
- Branches depend on Trunk
- Branches can depend on other branches (with caution)
- Never: Trunk → Branch, Branch → Accounts (except auth)

## Data Flow: Audit Creation

```
User Request
    │
    ▼
┌─────────────────┐
│  AuditCreateView│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  AuditForm      │ (Validation)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  AuditService   │ (Business Logic)
│  .create_audit()│
└────────┬────────┘
         │
         ├─────────────────┐
         │                 │
         ▼                 ▼
┌──────────────┐   ┌──────────────┐
│AuditWorkflow │   │AuditRepository│
│.validate()   │   │.create()     │
└──────────────┘   └──────┬───────┘
                          │
                          ▼
                   ┌──────────────┐
                   │  Audit Model  │
                   │  .save()     │
                   └──────┬───────┘
                          │
                          ▼
                   ┌──────────────┐
                   │EventDispatcher│
                   │.emit()       │
                   └──────┬───────┘
                          │
         ┌────────────────┼────────────────┐
         │                │                │
         ▼                ▼                ▼
    ┌─────────┐    ┌──────────┐    ┌──────────┐
    │Email    │    │Log       │    │Webhook   │
    │Handler  │    │Handler   │    │Handler   │
    └─────────┘    └──────────┘    └──────────┘
```

## Permission System Architecture

```
┌─────────────────────────────────────────────────┐
│            Permission Request                     │
└────────────────────┬──────────────────────────────┘
                     │
         ┌───────────▼───────────┐
         │  Permission Backend   │
         └───────────┬───────────┘
                     │
    ┌────────────────┼────────────────┐
    │                │                │
    ▼                ▼                ▼
┌─────────┐    ┌──────────┐    ┌──────────┐
│  Role   │    │Permission│    │  Object  │
│  Check  │    │  Check   │    │  Check   │
└────┬────┘    └────┬─────┘    └────┬─────┘
     │              │               │
     └──────────────┼───────────────┘
                    │
                    ▼
         ┌──────────────────┐
         │  Permission      │
         │  Predicates      │
         └──────────────────┘
                    │
                    ▼
         ┌──────────────────┐
         │  Allow/Deny      │
         └──────────────────┘
```

## Workflow State Machine: Audit

```
                    [*]
                     │
                     ▼
                  ┌──────┐
                  │Draft │
                  └──┬───┘
                     │
         ┌───────────┼───────────┐
         │                       │
         ▼                       ▼
    ┌──────────┐          ┌──────────────┐
    │Client    │          │Submitted     │
    │Review    │─────────▶│to CB         │
    └────┬─────┘          └──────┬───────┘
         │                       │
         │                       │
         └───────────┬───────────┘
                     │
                     ▼
                ┌────────┐
                │Decided │
                └───┬────┘
                    │
                    ▼
                   [*]
```

**Transitions:**

- `draft` → `client_review` (Lead Auditor)
- `client_review` → `draft` (Lead Auditor)
- `client_review` → `submitted_to_cb` (Client Admin)
- `submitted_to_cb` → `decided` (CB Admin)

## Workflow State Machine: Nonconformity

```
                    [*]
                     │
                     ▼
                  ┌──────┐
                  │Open  │
                  └──┬───┘
                     │
                     ▼
            ┌────────────────┐
            │Client Responded│
            └───────┬────────┘
                    │
                    ▼
            ┌──────────────┐
            │   Accepted   │
            └───────┬──────┘
                    │
                    ▼
            ┌──────────────┐
            │    Closed    │
            └───────┬──────┘
                    │
                    ▼
                   [*]
```

## Event Flow: Audit Status Change

```
┌─────────────────────────────────────────────────┐
│  AuditService.transition_status()               │
└────────────────────┬────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────┐
│  AuditWorkflow.transition()                     │
│  • Validate transition                           │
│  • Update status                                 │
└────────────────────┬────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────┐
│  EventDispatcher.emit(                          │
│    'audit.status_changed',                      │
│    { audit, old_status, new_status, user }      │
│  )                                              │
└────────────────────┬────────────────────────────┘
                     │
    ┌────────────────┼────────────────┐
    │                │                │
    ▼                ▼                ▼
┌─────────┐    ┌──────────┐    ┌──────────┐
│Email    │    │Log       │    │Webhook   │
│Handler  │    │Handler   │    │Handler   │
│         │    │          │    │          │
│Send     │    │Record    │    │Notify    │
│notification│ │event     │    │external  │
│         │    │          │    │system    │
└─────────┘    └──────────┘    └──────────┘
```

## Database Schema: Core Relationships

```
┌─────────────────┐
│  Organization   │
│  ─────────────  │
│  • id           │
│  • name         │
│  • customer_id  │
└────────┬────────┘
         │
         │ 1:N
         │
    ┌────┴────┬──────────────┐
    │         │              │
    ▼         ▼              ▼
┌────────┐ ┌──────────┐ ┌──────────────┐
│  Site  │ │Certification│ │  Profile   │
│  ────  │ │  ────────  │ │  ────────   │
│  • id  │ │  • id      │ │  • id       │
│  • org │ │  • org     │ │  • user     │
│  • name│ │  • standard│ │  • org      │
└────────┘ └─────┬──────┘ └─────────────┘
                 │
                 │ N:M
                 │
            ┌────▼─────┐
            │  Audit   │
            │  ─────   │
            │  • id    │
            │  • org   │
            └────┬─────┘
                 │
         ┌────────┼────────┐
         │        │        │
         ▼        ▼        ▼
    ┌────────┐ ┌──────┐ ┌──────────┐
    │Finding │ │Team  │ │Evidence  │
    │        │ │Member│ │File      │
    └────────┘ └──────┘ └──────────┘
```

## Service Layer Interaction

```
┌─────────────────────────────────────────────────┐
│                    View Layer                    │
│  ┌──────────────┐  ┌──────────────┐             │
│  │AuditCreateView│ │AuditListView │             │
│  └──────┬───────┘  └──────┬───────┘             │
└─────────┼─────────────────┼─────────────────────┘
          │                 │
          ▼                 ▼
┌─────────────────────────────────────────────────┐
│                  Service Layer                   │
│  ┌──────────────┐  ┌──────────────┐             │
│  │AuditService  │  │FindingService│             │
│  │              │  │              │             │
│  │• create()    │  │• create_nc() │             │
│  │• update()    │  │• update()   │             │
│  │• transition()│  │• verify()   │             │
│  └──────┬───────┘  └──────┬───────┘             │
└─────────┼─────────────────┼─────────────────────┘
          │                 │
          ├─────────────────┤
          │                 │
          ▼                 ▼
┌─────────────────────────────────────────────────┐
│                Repository Layer                   │
│  ┌──────────────┐  ┌──────────────┐             │
│  │AuditRepo     │  │FindingRepo   │             │
│  │              │  │              │             │
│  │• get()       │  │• get()       │             │
│  │• list()      │  │• list()      │             │
│  │• create()    │  │• create()   │             │
│  │• update()    │  │• update()   │             │
│  └──────┬───────┘  └──────┬───────┘             │
└─────────┼─────────────────┼─────────────────────┘
          │                 │
          ▼                 ▼
┌─────────────────────────────────────────────────┐
│                   Model Layer                   │
│  ┌──────────────┐  ┌──────────────┐             │
│  │    Audit     │  │   Finding    │             │
│  └──────────────┘  └──────────────┘             │
└─────────────────────────────────────────────────┘
```

## Deployment Architecture

```
                    ┌─────────────┐
                    │   Users     │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │  Load       │
                    │  Balancer   │
                    └──────┬──────┘
                           │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│  App Server  │   │  App Server  │   │  App Server  │
│  (Gunicorn)  │   │  (Gunicorn)  │   │  (Gunicorn)  │
└──────┬───────┘   └──────┬───────┘   └──────┬───────┘
       │                  │                  │
       └──────────────────┼──────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌──────────────┐   ┌──────────────┐  ┌──────────────┐
│  PostgreSQL  │   │  Redis       │  │  S3/Blob     │
│  (Primary)   │   │  (Cache)     │  │  (Storage)   │
└──────────────┘   └──────────────┘  └──────────────┘
        │
        ▼
┌──────────────┐
│  PostgreSQL  │
│  (Replica)   │
└──────────────┘
```

## Module Communication Pattern

```
┌──────────────┐
│  Audits      │
│  Module      │
└──────┬───────┘
       │
       │ Event: 'audit.created'
       │
       ▼
┌──────────────┐
│   Event      │
│  Dispatcher  │
│  (Trunk)     │
└──────┬───────┘
       │
       ├─────────────────┐
       │                 │
       ▼                 ▼
┌──────────────┐   ┌──────────────┐
│  Risk        │   │  Documents   │
│  Module      │   │  Module      │
│              │   │              │
│  Handler:    │   │  Handler:    │
│  Create risk │   │  Link doc    │
│  from audit  │   │  to audit    │
└──────────────┘   └──────────────┘
```

**Key Principle**: Modules communicate through events, not direct imports.
