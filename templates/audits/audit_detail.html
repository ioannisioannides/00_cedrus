{% extends "base.html" %}

{% block title %}Audit {{ audit.pk }} - Cedrus{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Audit Details</h1>
        <p class="page-subtitle">Audit #{{ audit.pk }} - {{ audit.organization.name }}</p>
    </div>
    <div class="page-actions">
        {% if can_edit %}
            <a href="{% url 'audit_management:audit_update' audit.pk %}" class="btn btn-primary">Edit</a>
        {% endif %}
        {% if can_submit_to_client %}
            <a href="{% url 'audit_management:audit_transition_status' audit.pk 'client_review' %}" class="btn btn-success" onclick="return confirm('Submit this audit to the client for review?');">Submit to Client</a>
        {% endif %}
        {% if can_start_technical_review %}
            <a href="{% url 'audit_management:audit_transition_status' audit.pk 'technical_review' %}" class="btn btn-info" onclick="return confirm('Start technical review?');">Start Technical Review</a>
        {% endif %}
        {% if can_conduct_technical_review %}
            <a href="{% url 'certification:technical_review_create' audit.pk %}" class="btn btn-info">Conduct Technical Review</a>
        {% endif %}
        {% if can_make_decision %}
            <a href="{% url 'audit_management:audit_make_decision' audit.pk %}" class="btn btn-warning">Make Decision</a>
        {% endif %}
        {% if available_transitions %}
            {% for status_code, status_display in available_transitions %}
                {% if status_code != 'client_review' and status_code != 'decided' and status_code != 'technical_review' %}
                    <a href="{% url 'audit_management:audit_transition_status' audit.pk status_code %}" class="btn btn-outline-primary btn-sm">{{ status_display }}</a>
                {% endif %}
            {% endfor %}
        {% endif %}
        
        <!-- Reporting Actions -->
        <div class="btn-group me-2">
            <a href="{% url 'reporting:audit_report_pdf' audit.pk %}" class="btn btn-outline-secondary" target="_blank">
                <i class="bi bi-file-earmark-pdf"></i> PDF Report
            </a>
            {% if audit.status == 'decided' or audit.status == 'closed' %}
                <a href="{% url 'reporting:certificate_pdf' audit.pk %}" class="btn btn-outline-success" target="_blank">
                    <i class="bi bi-award"></i> Certificate
                </a>
            {% endif %}
        </div>

        <a href="{% url 'audit_management:audit_print' audit.pk %}" class="btn btn-outline-secondary">Print</a>
        <a href="{% url 'audit_management:audit_list' %}" class="btn btn-outline-secondary">Back to List</a>
    </div>
</div>

<!-- Progress Tracker -->
{% include "audits/includes/progress_tracker.html" %}

<!-- Basic Information -->
<div class="row g-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Basic Information</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">Organization</dt>
                    <dd class="col-sm-7">
                        <strong>{{ audit.organization.name }}</strong>
                    </dd>
                    
                    <dt class="col-sm-5">Type</dt>
                    <dd class="col-sm-7">{{ audit.get_audit_type_display }}</dd>
                    
                    <dt class="col-sm-5">Status</dt>
                    <dd class="col-sm-7">
                        <span class="badge bg-secondary">{{ audit.get_status_display }}</span>
                    </dd>
                    
                    <dt class="col-sm-5">Lead Auditor</dt>
                    <dd class="col-sm-7">{{ audit.lead_auditor.get_full_name|default:audit.lead_auditor.username }}</dd>
                </dl>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Schedule</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">Start Date</dt>
                    <dd class="col-sm-7">{{ audit.total_audit_date_from|date:"F d, Y" }}</dd>
                    
                    <dt class="col-sm-5">End Date</dt>
                    <dd class="col-sm-7">{{ audit.total_audit_date_to|date:"F d, Y" }}</dd>
                    
                    <dt class="col-sm-5">Duration</dt>
                    <dd class="col-sm-7">
                        <strong>{{ audit.planned_duration_hours }} hours</strong>
                    </dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- Certifications & Sites -->
<div class="row g-4 mt-0">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Certifications</h5>
            </div>
            <div class="card-body">
                {% if audit.certifications.all %}
                    <ul class="mb-0">
                        {% for cert in audit.certifications.all %}
                            <li><strong>{{ cert.standard.code }}</strong> - {{ cert.standard.name }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">No certifications assigned.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Sites</h5>
                {% if is_multi_site %}
                <span class="badge bg-info">Multi-Site ({{ audit.sites.count }})</span>
                {% endif %}
            </div>
            <div class="card-body">
                {% if audit.sites.all %}
                    <ul class="mb-0">
                        {% for site in audit.sites.all %}
                            <li><strong>{{ site.site_name }}</strong> - {{ site.site_address|truncatewords:5 }}</li>
                        {% endfor %}
                    </ul>
                    
                    {% if is_multi_site and sampling_info %}
                    <div class="alert alert-info mt-3 mb-0" role="alert">
                        <h6 class="alert-heading"><i class="bi bi-calculator"></i> IAF MD1 Sampling Requirements</h6>
                        <p class="mb-2"><strong>Minimum Sites to Audit:</strong> {{ sampling_info.minimum_sites }} of {{ sampling_info.total_sites }}</p>
                        <p class="mb-0"><small class="text-muted">
                            Base calculation: {{ sampling_info.base_calculation }} 
                            {% if sampling_info.risk_adjustment > 0 %}
                            + {{ sampling_info.risk_adjustment }} (risk factors)
                            {% endif %}
                        </small></p>
                        {% if sampling_info.risk_factors %}
                        <hr class="my-2">
                        <p class="mb-1"><strong>Risk Factors:</strong></p>
                        <ul class="small mb-0">
                            {% for factor in sampling_info.risk_factors %}
                            <li>{{ factor }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    {% elif sampling_error %}
                    <div class="alert alert-warning mt-3 mb-0" role="alert">
                        <small>Unable to calculate sampling requirements: {{ sampling_error }}</small>
                    </div>
                    {% endif %}
                {% else %}
                    <p class="text-muted mb-0">No sites assigned.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Audit Documentation -->
{% if can_edit %}
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Audit Documentation</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Organization Changes</span>
                    <a href="{% url 'audit_management:audit_changes_edit' audit.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Audit Plan Review</span>
                    <a href="{% url 'audit_management:audit_plan_review_edit' audit.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Audit Summary</span>
                    <a href="{% url 'audit_management:audit_summary_edit' audit.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Recommendations</span>
                    <a href="{% url 'audit_management:audit_recommendation_edit' audit.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Team Members -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Team Members</h5>
        {% if can_edit %}
        <a href="{% url 'audit_management:team_member_add' audit.pk %}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-circle"></i> Add Team Member
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if audit.team_members.all %}
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Title</th>
                            <th>Role</th>
                            <th>Dates</th>
                            <th>Type</th>
                            {% if can_edit %}
                            <th class="text-end">Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in audit.team_members.all %}
                            <tr>
                                <td><strong>{{ member.name }}</strong></td>
                                <td>{{ member.title|default:"—" }}</td>
                                <td>{{ member.get_role_display }}</td>
                                <td>
                                    <small>{{ member.date_from|date:"M d, Y" }} to {{ member.date_to|date:"M d, Y" }}</small>
                                </td>
                                <td>
                                    {% if member.user %}
                                    <span class="badge bg-primary" title="Internal team member with user account">Internal</span>
                                    {% else %}
                                    <span class="badge bg-secondary" title="External expert without user account">External</span>
                                    {% endif %}
                                </td>
                                {% if can_edit %}
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'audit_management:team_member_edit' member.pk %}" class="btn btn-outline-primary" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'audit_management:team_member_delete' member.pk %}" class="btn btn-outline-danger" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted mb-0">No team members assigned.</p>
            {% if can_edit %}
            <p class="mt-2">
                <a href="{% url 'audit_management:team_member_add' audit.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus-circle"></i> Add First Team Member
                </a>
            </p>
            {% endif %}
        {% endif %}
    </div>
</div>

<!-- Findings Summary -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Findings Summary</h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="border rounded p-3 bg-light">
                    <h3 class="text-danger mb-1">{{ nonconformities|length }}</h3>
                    <p class="mb-0 text-muted">Total NCs</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="border rounded p-3 bg-light">
                    <h3 class="text-warning mb-1">{{ open_ncs_count }}</h3>
                    <p class="mb-0 text-muted">Open NCs</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="border rounded p-3 bg-light">
                    <h3 class="text-info mb-1">{{ observations|length }}</h3>
                    <p class="mb-0 text-muted">Observations</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="border rounded p-3 bg-light">
                    <h3 class="text-success mb-1">{{ ofis|length }}</h3>
                    <p class="mb-0 text-muted">OFIs</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Nonconformities -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Nonconformities
        {% if nonconformities %}
                <span class="badge bg-danger ms-2">{{ nonconformities|length }}</span>
            {% endif %}
        </h5>
        {% if can_add_findings %}
            <a href="{% url 'audit_management:nonconformity_create' audit.pk %}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-circle"></i> Add Nonconformity
            </a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if nonconformities %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Clause</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Due Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for nc in nonconformities %}
                            <tr>
                                <td>
                                    <a href="{% url 'audit_management:nonconformity_detail' nc.pk %}">
                                        <strong>{{ nc.clause }}</strong>
                                    </a>
                                </td>
                                <td>
                                    <span class="badge bg-{% if nc.category == 'major' %}danger{% else %}warning{% endif %}">
                                        {{ nc.get_category_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ nc.get_verification_status_display }}</span>
                                </td>
                                <td>{{ nc.due_date|date:"M d, Y"|default:"—" }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        {% if can_edit and nc.verification_status == 'open' %}
                                            <a href="{% url 'audit_management:nonconformity_update' nc.pk %}" class="btn btn-outline-primary">
                                                <i class="bi bi-pencil"></i> Edit
                                            </a>
                                            <a href="{% url 'audit_management:nonconformity_delete' nc.pk %}" class="btn btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        {% endif %}
                                        {% if is_client and nc.verification_status == 'open' %}
                                            <a href="{% url 'audit_management:nonconformity_respond' nc.pk %}" class="btn btn-outline-success">
                                                <i class="bi bi-chat-dots"></i> Respond
                                            </a>
                                        {% endif %}
                                        {% if can_add_findings and nc.verification_status == 'client_responded' %}
                                            <a href="{% url 'audit_management:nonconformity_verify' nc.pk %}" class="btn btn-outline-success">
                                                <i class="bi bi-check-circle"></i> Verify
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted mb-0">No nonconformities recorded.</p>
        {% endif %}
    </div>
</div>

<!-- Observations -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Observations
        {% if observations %}
                <span class="badge bg-info ms-2">{{ observations|length }}</span>
            {% endif %}
        </h5>
        {% if can_add_findings %}
            <a href="{% url 'audit_management:observation_create' audit.pk %}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-circle"></i> Add Observation
            </a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if observations %}
            <ul class="list-unstyled mb-0">
                {% for obs in observations %}
                    <li class="mb-3 pb-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <a href="{% url 'audit_management:observation_detail' obs.pk %}">
                                    <strong class="d-block mb-1">{{ obs.clause }}</strong>
                                </a>
                                <p class="mb-0">{{ obs.objective_evidence|truncatewords:30 }}</p>
                            </div>
                            {% if can_edit %}
                                <div class="btn-group btn-group-sm ms-3">
                                    <a href="{% url 'audit_management:observation_update' obs.pk %}" class="btn btn-outline-primary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{% url 'audit_management:observation_delete' obs.pk %}" class="btn btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted mb-0">No observations recorded.</p>
        {% endif %}
    </div>
</div>

<!-- Opportunities for Improvement -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Opportunities for Improvement
        {% if ofis %}
                <span class="badge bg-success ms-2">{{ ofis|length }}</span>
            {% endif %}
        </h5>
        {% if can_add_findings %}
            <a href="{% url 'audit_management:ofi_create' audit.pk %}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-circle"></i> Add OFI
            </a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if ofis %}
            <ul class="list-unstyled mb-0">
                {% for ofi in ofis %}
                    <li class="mb-3 pb-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <a href="{% url 'audit_management:ofi_detail' ofi.pk %}">
                                    <strong class="d-block mb-1">{{ ofi.clause }}</strong>
                                </a>
                                <p class="mb-0">{{ ofi.objective_evidence|truncatewords:30 }}</p>
                            </div>
                            {% if can_edit %}
                                <div class="btn-group btn-group-sm ms-3">
                                    <a href="{% url 'audit_management:ofi_update' ofi.pk %}" class="btn btn-outline-primary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{% url 'audit_management:ofi_delete' ofi.pk %}" class="btn btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted mb-0">No opportunities for improvement recorded.</p>
        {% endif %}
    </div>
</div>

<!-- Evidence Files -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Evidence Files
            {% if audit.evidence_files.count %}
                <span class="badge bg-info ms-2">{{ audit.evidence_files.count }}</span>
            {% endif %}
        </h5>
        {% if can_add_findings or is_client %}
            <a href="{% url 'audit_management:evidence_file_upload' audit.pk %}" class="btn btn-sm btn-primary">Upload File</a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if audit.evidence_files.all %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>File Name</th>
                            <th>Linked To</th>
                            <th>Uploaded By</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in audit.evidence_files.all %}
                            <tr>
                                <td><strong>{{ file.file.name|slice:"18:" }}</strong></td>
                                <td>
                                    {% if file.finding %}
                                        <span class="badge bg-warning">NC: {{ file.finding.clause }}</span>
                                    {% else %}
                                        <span class="text-muted">General</span>
                                    {% endif %}
                                </td>
                                <td>{{ file.uploaded_by.get_full_name|default:file.uploaded_by.username }}</td>
                                <td><small>{{ file.uploaded_at|date:"M d, Y" }}</small></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'audit_management:evidence_file_download' file.pk %}" class="btn btn-outline-success">Download</a>
                                        {% if can_edit or file.uploaded_by == request.user %}
                                            <a href="{% url 'audit_management:evidence_file_delete' file.pk %}" class="btn btn-outline-danger">Delete</a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted mb-0">No evidence files uploaded.</p>
        {% endif %}
    </div>
</div>

<!-- Certification Decision -->
{% endblock %}

