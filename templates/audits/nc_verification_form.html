{% extends "base.html" %}
{% load static %}

{% block title %}Verify Nonconformity Response - Cedrus{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'audit_management:audit_list' %}">Audits</a></li>
            <li class="breadcrumb-item"><a href="{% url 'audit_management:audit_detail' audit.pk %}">{{ audit.audit_number }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Verify NC Response</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2>Verify Nonconformity Response</h2>
            <p class="text-muted">
                Audit: <strong>{{ audit.audit_number }}</strong> - {{ audit.organization.name }}
            </p>
        </div>
    </div>

    <!-- NC Details -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-exclamation-triangle"></i> 
                        {{ nc.get_category_display }} Nonconformity - Clause {{ nc.clause }}
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-3">Standard</dt>
                        <dd class="col-sm-9">{{ nc.standard|default:"Not specified" }}</dd>

                        <dt class="col-sm-3">Objective Evidence</dt>
                        <dd class="col-sm-9">{{ nc.objective_evidence }}</dd>

                        <dt class="col-sm-3">Statement</dt>
                        <dd class="col-sm-9">{{ nc.statement_of_nc }}</dd>

                        <dt class="col-sm-3">Auditor Explanation</dt>
                        <dd class="col-sm-9">{{ nc.auditor_explanation }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Response -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Client Response</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">Root Cause Analysis</dt>
                        <dd class="col-sm-9">{{ nc.client_root_cause }}</dd>

                        <dt class="col-sm-3">Immediate Correction</dt>
                        <dd class="col-sm-9">{{ nc.client_correction }}</dd>

                        <dt class="col-sm-3">Corrective Action Plan</dt>
                        <dd class="col-sm-9">{{ nc.client_corrective_action }}</dd>

                        <dt class="col-sm-3">Target Completion Date</dt>
                        <dd class="col-sm-9">{{ nc.due_date|date:"M d, Y" }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Verification Form -->
    <div class="row">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Verification Assessment</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" role="alert">
                        <strong>Instructions:</strong> Review the client's response and determine if the corrective action 
                        is appropriate. Select "Accepted" if the plan is satisfactory, or "Closed" if you've verified 
                        the corrective action has been effectively implemented.
                    </div>

                    <form method="post" novalidate aria-label="NC verification form">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger" role="alert">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <!-- Verification Status -->
                        <div class="mb-3">
                            <label for="{{ form.verification_status.id_for_label }}" class="form-label">
                                Verification Decision <span class="text-danger">*</span>
                            </label>
                            {{ form.verification_status }}
                            {% if form.verification_status.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.verification_status.errors }}
                            </div>
                            {% endif %}
                            {% if form.verification_status.help_text %}
                            <div class="form-text">{{ form.verification_status.help_text }}</div>
                            {% endif %}
                        </div>

                        <!-- Verification Notes -->
                        <div class="mb-3">
                            <label for="{{ form.verification_notes.id_for_label }}" class="form-label">
                                Verification Notes <span class="text-danger">*</span>
                            </label>
                            {{ form.verification_notes }}
                            {% if form.verification_notes.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.verification_notes.errors }}
                            </div>
                            {% endif %}
                            {% if form.verification_notes.help_text %}
                            <div class="form-text">{{ form.verification_notes.help_text }}</div>
                            {% endif %}
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex justify-content-between align-items-center mt-4" style="padding-top: 1.5rem; border-top: 1px solid var(--border-secondary);">
                            <a href="{% url 'audit_management:audit_detail' audit.pk %}" class="btn btn-ghost">
                                <i class="bi bi-arrow-left me-1" aria-hidden="true"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-lg me-1" aria-hidden="true"></i> Submit Verification
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
