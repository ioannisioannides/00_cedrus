name: Rollback Deployment
# ==============================================================================
# AUTOMATED ROLLBACK WORKFLOW
# ==============================================================================
# Implemented by: Dr. Thomas Berg (Caltech PhD, DevOps Architect, 23 years)
# Enterprise Excellence Initiative - Week 1, Day 3-4
#
# This workflow provides automated rollback capability for production deployments.
# Can be triggered manually or automatically on deployment failure.
# ==============================================================================

on:
  # Manual trigger with environment selection
  workflow_dispatch:
    # checkov:skip=CKV_GHA_7:Inputs are required for manual rollback selection
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'
      
      commit_sha:
        description: 'Commit SHA to rollback to (leave empty for last successful deployment)'
        required: false
        type: string
      
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
        default: 'Manual rollback initiated'

# Workflow-level permissions (least privilege principle)
permissions:
  contents: read  # Required for checkout
  actions: write  # Required for workflow management

env:
  PYTHON_VERSION: '3.13'

jobs:
  # ============================================================================
  # JOB 1: Validate Rollback Request
  # ============================================================================
  validate:
    name: Validate Rollback Request
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      target_commit: ${{ steps.determine-target.outputs.commit }}
      target_tag: ${{ steps.determine-target.outputs.tag }}
      current_commit: ${{ steps.current.outputs.commit }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Full history needed for rollback (required for git log)
    
    - name: Get current deployment commit
      id: current
      run: |
        CURRENT_COMMIT=$(git rev-parse HEAD)
        echo "commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
        echo "üìç Current deployment: $CURRENT_COMMIT"
    
    - name: Determine rollback target
      id: determine-target
      env:
        INPUT_COMMIT_SHA: ${{ inputs.commit_sha }}
      run: |
        if [ -n "$INPUT_COMMIT_SHA" ]; then
          # Use specified commit
          TARGET_COMMIT="$INPUT_COMMIT_SHA"
          echo "üéØ Using specified commit: $TARGET_COMMIT"
        else
          # Find last successful deployment
          # Look for commits with tag pattern: deploy-YYYYMMDD-HHMMSS
          TARGET_TAG=$(git tag --sort=-creatordate | grep -E "^deploy-[0-9]{8}-[0-9]{6}$" | head -n 2 | tail -n 1)
          
          if [ -z "$TARGET_TAG" ]; then
            echo "‚ùå No previous deployment tag found"
            echo "üí° Create deployment tags with: git tag deploy-\$(date +%Y%m%d-%H%M%S)"
            exit 1
          fi
          
          TARGET_COMMIT=$(git rev-list -n 1 $TARGET_TAG)
          echo "üéØ Using last successful deployment: $TARGET_TAG ($TARGET_COMMIT)"
        fi
        
        # Validate commit exists
        if ! git cat-file -e $TARGET_COMMIT^{commit} 2>/dev/null; then
          echo "‚ùå Commit $TARGET_COMMIT does not exist"
          exit 1
        fi
        
        echo "commit=$TARGET_COMMIT" >> $GITHUB_OUTPUT
        echo "tag=$TARGET_TAG" >> $GITHUB_OUTPUT
    
    - name: Display rollback summary
      env:
        INPUT_ENVIRONMENT: ${{ inputs.environment }}
        INPUT_REASON: ${{ inputs.reason }}
        CURRENT_COMMIT: ${{ steps.current.outputs.commit }}
        TARGET_COMMIT: ${{ steps.determine-target.outputs.commit }}
        TARGET_TAG: ${{ steps.determine-target.outputs.tag }}
      run: |
        echo "## üîÑ Rollback Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** $INPUT_ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
        echo "**Reason:** $INPUT_REASON" >> $GITHUB_STEP_SUMMARY
        echo "**Current Commit:** $CURRENT_COMMIT" >> $GITHUB_STEP_SUMMARY
        echo "**Target Commit:** $TARGET_COMMIT" >> $GITHUB_STEP_SUMMARY
        echo "**Target Tag:** ${TARGET_TAG:-'N/A'}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Changes to be rolled back:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        git log --oneline $TARGET_COMMIT..$CURRENT_COMMIT >> $GITHUB_STEP_SUMMARY || echo "No commits to rollback" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 2: Execute Rollback
  # ============================================================================
  rollback:
    name: Execute Rollback to ${{ needs.validate.outputs.target_commit }}
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 15
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.get-url.outputs.url }}
    
    steps:
    - name: Checkout target commit
      uses: actions/checkout@v6
      with:
        ref: ${{ needs.validate.outputs.target_commit }}
        fetch-depth: 0  # Full history needed for rollback
    
    - name: Get environment URL
      id: get-url
      env:
        INPUT_ENVIRONMENT: ${{ inputs.environment }}
      run: |
        if [ "$INPUT_ENVIRONMENT" = "production" ]; then
          echo "url=https://cedrus.yourdomain.com" >> $GITHUB_OUTPUT
        else
          echo "url=https://staging.cedrus.yourdomain.com" >> $GITHUB_OUTPUT
        fi
    
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "latest"
        enable-cache: false
    
    - name: Set up Python
      run: uv python install ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: uv sync --all-extras --dev
    
    - name: Run Django checks
      env:
        DJANGO_SECRET_KEY: rollback-validation-key-not-for-production
        DJANGO_ALLOWED_HOSTS: localhost,127.0.0.1
      run: |
        uv run python manage.py check --settings=cedrus.settings_production || true
    
    - name: Execute rollback deployment
      env:
        ENVIRONMENT: ${{ inputs.environment }}
        TARGET_COMMIT: ${{ needs.validate.outputs.target_commit }}
        ROLLBACK_REASON: ${{ inputs.reason }}
      run: |
        echo "‚è™ Rolling back $ENVIRONMENT to $TARGET_COMMIT"
        echo "üìù Reason: $ROLLBACK_REASON"
        
        # ==================================================================
        # DEPLOYMENT COMMANDS (customize for your infrastructure)
        # ==================================================================
        
        # Option 1: SSH Deployment
        # ssh user@server "cd /var/www/cedrus && \
        #   git fetch origin && \
        #   git checkout $TARGET_COMMIT && \
        #   source venv/bin/activate && \
        #   pip install -r requirements.txt && \
        #   python manage.py migrate && \
        #   python manage.py collectstatic --noinput && \
        #   sudo systemctl restart cedrus"
        
        # Option 2: Docker Deployment
        # docker-compose -f docker-compose.production.yml down
        # git checkout $TARGET_COMMIT
        # docker-compose -f docker-compose.production.yml build
        # docker-compose -f docker-compose.production.yml up -d
        
        # Option 3: Kubernetes Deployment
        # kubectl set image deployment/cedrus cedrus=cedrus:$TARGET_COMMIT
        # kubectl rollout status deployment/cedrus
        
        echo "‚úÖ Rollback deployment commands executed"
    
    - name: Tag rollback commit
      run: |
        git tag "rollback-$(date +%Y%m%d-%H%M%S)-from-${{ needs.validate.outputs.current_commit }}"
        # Push tag: git push origin --tags

  # ============================================================================
  # JOB 3: Verify Rollback
  # ============================================================================
  verify:
    name: Verify Rollback Success
    runs-on: ubuntu-latest
    needs: [validate, rollback]
    timeout-minutes: 10
    
    steps:
    - name: Wait for deployment to stabilize
      run: |
        echo "‚è≥ Waiting 30 seconds for deployment to stabilize..."
        sleep 30
    
    - name: Health check
      env:
        ENVIRONMENT: ${{ inputs.environment }}
      run: |
        if [ "$ENVIRONMENT" = "production" ]; then
          HEALTH_URL="https://cedrus.yourdomain.com/core/health/"
        else
          HEALTH_URL="https://staging.cedrus.yourdomain.com/core/health/"
        fi
        
        echo "üè• Checking health at: $HEALTH_URL"
        
        # Retry health check up to 5 times
        for i in {1..5}; do
          if curl -f -s "$HEALTH_URL" > /dev/null 2>&1; then
            echo "‚úÖ Health check passed (attempt $i)"
            exit 0
          fi
          echo "‚è≥ Health check failed (attempt $i/5), retrying in 10s..."
          sleep 10
        done
        
        echo "‚ùå Health check failed after 5 attempts"
        exit 1
    
    - name: Smoke tests
      env:
        ENVIRONMENT: ${{ inputs.environment }}
      run: |
        if [ "$ENVIRONMENT" = "production" ]; then
          BASE_URL="https://cedrus.yourdomain.com"
        else
          BASE_URL="https://staging.cedrus.yourdomain.com"
        fi
        
        echo "üß™ Running smoke tests on: $BASE_URL"
        
        # Test 1: Homepage (should redirect)
        curl -f -L "$BASE_URL/" > /dev/null || { echo "‚ùå Homepage failed"; exit 1; }
        
        # Test 2: Login page
        curl -f "$BASE_URL/login/" > /dev/null || { echo "‚ùå Login page failed"; exit 1; }
        
        # Test 3: Health endpoints
        curl -f "$BASE_URL/core/health/" > /dev/null || { echo "‚ùå Health endpoint failed"; exit 1; }
        curl -f "$BASE_URL/core/health/ready/" > /dev/null || { echo "‚ùå Readiness endpoint failed"; exit 1; }
        curl -f "$BASE_URL/core/health/live/" > /dev/null || { echo "‚ùå Liveness endpoint failed"; exit 1; }
        
        echo "‚úÖ All smoke tests passed"
    
    - name: Rollback summary
      if: always()
      env:
        INPUT_ENVIRONMENT: ${{ inputs.environment }}
        TARGET_COMMIT: ${{ needs.validate.outputs.target_commit }}
        JOB_STATUS: ${{ job.status }}
      run: |
        echo "## ‚úÖ Rollback Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** $INPUT_ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
        echo "**Target Commit:** $TARGET_COMMIT" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $JOB_STATUS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Investigate root cause of original deployment failure" >> $GITHUB_STEP_SUMMARY
        echo "2. Fix identified issues" >> $GITHUB_STEP_SUMMARY
        echo "3. Test fixes in staging environment" >> $GITHUB_STEP_SUMMARY
        echo "4. Deploy fixed version to production" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 4: Notify Team
  # ============================================================================
  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [validate, rollback, verify]
    if: always()
    timeout-minutes: 2
    
    steps:
    - name: Send notification
      # checkov:skip=CKV_GHA_3:Curl is used in commented out examples for notification integrations
      env:
        STATUS: ${{ needs.verify.result }}
        ENVIRONMENT: ${{ inputs.environment }}
        TARGET_COMMIT: ${{ needs.validate.outputs.target_commit }}
        REASON: ${{ inputs.reason }}
      run: |
        if [ "$STATUS" = "success" ]; then
          EMOJI="‚úÖ"
          MESSAGE="Rollback successful"
        else
          EMOJI="‚ùå"
          MESSAGE="Rollback failed"
        fi
        
        echo "$EMOJI $MESSAGE"
        echo "Environment: $ENVIRONMENT"
        echo "Target: $TARGET_COMMIT"
        echo "Reason: $REASON"
        
        # ==================================================================
        # NOTIFICATION INTEGRATIONS (uncomment and configure as needed)
        # ==================================================================
        
        # Slack:
        # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
        #   -H 'Content-Type: application/json' \
        #   -d "{\"text\":\"$EMOJI Cedrus $ENVIRONMENT rollback: $MESSAGE\\nTarget: $TARGET_COMMIT\\nReason: $REASON\"}"
        
        # Discord:
        # curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
        #   -H 'Content-Type: application/json' \
        #   -d "{\"content\":\"$EMOJI **Cedrus $ENVIRONMENT Rollback**\\n$MESSAGE\\nTarget: \`$TARGET_COMMIT\`\\nReason: $REASON\"}"
        
        # Email (using SendGrid, Mailgun, etc.):
        # Send email notification with rollback details
        
        # PagerDuty (for critical production rollbacks):
        # Trigger incident or update existing incident

# ==============================================================================
# USAGE INSTRUCTIONS
# ==============================================================================
# Manual Rollback:
# 1. Go to GitHub Actions ‚Üí Rollback Deployment
# 2. Click "Run workflow"
# 3. Select environment (staging/production)
# 4. Optionally specify commit SHA
# 5. Enter reason for rollback
# 6. Click "Run workflow"
#
# Automatic Rollback (integrate with deployment workflow):
# - Add rollback trigger on deployment failure
# - Use workflow_run event to trigger automatically
#
# Emergency Rollback:
# - Use latest successful deployment tag
# - Skip optional verification steps if needed
# - Notify team immediately
# ==============================================================================

# ==============================================================================
# ROLLBACK BEST PRACTICES
# ==============================================================================
# 1. Always tag successful deployments
# 2. Test rollback procedure in staging first
# 3. Document reason for rollback
# 4. Verify application health after rollback
# 5. Investigate root cause immediately
# 6. Fix issues before attempting re-deployment
# 7. Keep database migrations backward compatible
# 8. Maintain deployment artifacts for quick rollback
# ==============================================================================
