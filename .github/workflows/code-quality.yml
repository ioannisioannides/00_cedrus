name: Code Quality Gate
# Enterprise Excellence Initiative - Week 1, Day 3-4
# Strict code quality enforcement

on:
  pull_request:
    branches: [ main, develop ]

# Workflow-level permissions (least privilege principle)
permissions:
  contents: read  # Required for checkout
  pull-requests: write  # Required for PR comments

jobs:
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 1  # Shallow clone for speed
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.13'
        cache: 'pip'
    
    - name: Install quality tools
      run: |
        pip install black isort flake8 pylint radon
    
    - name: Check code formatting
      run: |
        echo "ğŸ¨ Checking code formatting with Black..."
        black --check accounts audits core cedrus || {
          echo "âŒ Code formatting issues detected"
          echo "ğŸ’¡ Run: black accounts audits core cedrus"
          exit 1
        }
    
    - name: Check import sorting
      run: |
        echo "ğŸ“¦ Checking import sorting with isort..."
        isort --check-only accounts audits core cedrus || {
          echo "âŒ Import sorting issues detected"
          echo "ğŸ’¡ Run: isort accounts audits core cedrus"
          exit 1
        }
    
    - name: Lint with flake8
      run: |
        echo "ğŸ” Linting with flake8..."
        flake8 accounts audits core cedrus --max-line-length=100 --max-complexity=10
    
    - name: Advanced linting with pylint
      continue-on-error: true
      run: |
        echo "ğŸ”¬ Advanced linting with pylint..."
        pylint accounts audits core cedrus --fail-under=8.0 || true
    
    - name: Code complexity analysis
      run: |
        echo "ğŸ“Š Analyzing code complexity..."
        radon cc accounts audits core cedrus -a -nb
        radon mi accounts audits core cedrus -nb
    
    - name: Quality gate summary
      run: |
        echo "âœ… All quality gates passed!"
        echo "ğŸ“ˆ Code meets enterprise standards"
