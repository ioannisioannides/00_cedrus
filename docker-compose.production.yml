# ==============================================================================
# CEDRUS DOCKER COMPOSE - PRODUCTION ENVIRONMENT (SELF-HOSTED)
# ==============================================================================
# Self-hosted production stack - Zero cloud costs
# Optimized for performance, security, and reliability
# 
# Stack:
# - Nginx reverse proxy with SSL (ports 80, 443)
# - Django + Gunicorn (4 workers)
# - PostgreSQL 16 with automated backups
# - Redis 7 for caching
# - Self-hosted monitoring (no external services)
# 
# Built by: Dr. Thomas Berg (Caltech PhD, DevOps, 23 years)
#           Dr. Alex MÃ¼ller (MIT PhD, Performance, 21 years)
# ==============================================================================

version: '3.9'

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  cedrus-frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24
  
  cedrus-backend:
    driver: bridge
    internal: true  # Backend not exposed to internet
    ipam:
      config:
        - subnet: 172.22.0.0/24

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  postgres-data-prod:
    driver: local
  
  postgres-backups:
    driver: local
  
  redis-data-prod:
    driver: local
  
  media-files-prod:
    driver: local
  
  static-files-prod:
    driver: local
  
  nginx-certs:
    driver: local
  
  nginx-logs:
    driver: local

# ==============================================================================
# SERVICES
# ==============================================================================
services:
  
  # ============================================================================
  # POSTGRESQL DATABASE (PRODUCTION)
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: cedrus-postgres-prod
    restart: always
    
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-cedrus_prod}
      POSTGRES_USER: ${POSTGRES_USER:-cedrus_prod}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD required}
      # Production tuning
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8 --data-checksums"
    
    volumes:
      - postgres-data-prod:/var/lib/postgresql/data
      - postgres-backups:/backups
      - ./docker/postgres/postgresql-prod.conf:/etc/postgresql/postgresql.conf:ro
      - ./docker/postgres/backup.sh:/usr/local/bin/backup.sh:ro
    
    networks:
      - cedrus-backend
    
    # No external port exposure for security
    # Access only through internal network
    
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /run/postgresql
      - /tmp
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-cedrus_prod} -d ${POSTGRES_DB:-cedrus_prod}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    
    # Security: Run as non-root
    user: postgres
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  
  # ============================================================================
  # REDIS CACHE (PRODUCTION)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: cedrus-redis-prod
    restart: always
    
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD required}
      --loglevel notice
    
    volumes:
      - redis-data-prod:/data
    
    networks:
      - cedrus-backend
    
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    
    healthcheck:
      test: ["CMD", "redis-cli", "--pass", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1536M
        reservations:
          cpus: '0.5'
          memory: 512M
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  
  # ============================================================================
  # DJANGO APPLICATION (PRODUCTION)
  # ============================================================================
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        UID: 1000
        GID: 1000
    
    image: cedrus:${VERSION:-latest}
    container_name: cedrus-web-prod
    restart: always
    
    # Production Gunicorn command (overrides Dockerfile CMD if needed)
    command: >
      gunicorn
      --bind 0.0.0.0:8000
      --workers 4
      --worker-class sync
      --worker-tmp-dir /dev/shm
      --max-requests 1000
      --max-requests-jitter 50
      --timeout 30
      --graceful-timeout 30
      --keep-alive 5
      --log-level info
      --access-logfile -
      --error-logfile -
      --capture-output
      cedrus.wsgi:application
    
    environment:
      # Django settings
      DJANGO_SETTINGS_MODULE: cedrus.settings_production
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:?DJANGO_SECRET_KEY required}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS:?DJANGO_ALLOWED_HOSTS required}
      DJANGO_DEBUG: "False"
      
      # Security settings
      DJANGO_SECURE_SSL_REDIRECT: "True"
      DJANGO_SESSION_COOKIE_SECURE: "True"
      DJANGO_CSRF_COOKIE_SECURE: "True"
      
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-cedrus_prod}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-cedrus_prod}
      
      # Redis cache
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD}@redis:6379/1
      CELERY_RESULT_BACKEND: redis://:${REDIS_PASSWORD}@redis:6379/2
      
      # Email (configure SMTP)
      EMAIL_BACKEND: django.core.mail.backends.smtp.EmailBackend
      EMAIL_HOST: ${EMAIL_HOST:-localhost}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_USE_TLS: ${EMAIL_USE_TLS:-True}
      EMAIL_HOST_USER: ${EMAIL_HOST_USER:-}
      EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD:-}
      DEFAULT_FROM_EMAIL: ${DEFAULT_FROM_EMAIL:-noreply@cedrus.local}
      
      # Static/Media files
      MEDIA_ROOT: /app/media
      STATIC_ROOT: /app/staticfiles
      
      # Sentry
      SENTRY_DSN: ${SENTRY_DSN}
      SENTRY_ENVIRONMENT: ${SENTRY_ENVIRONMENT:-production}
      
      # AWS S3
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_STORAGE_BUCKET_NAME: ${AWS_STORAGE_BUCKET_NAME}
      AWS_S3_REGION_NAME: ${AWS_S3_REGION_NAME}
      
      # Production optimizations
      PYTHONOPTIMIZE: "1"
      PYTHONUNBUFFERED: "1"
    
    volumes:
      # Read-only code (no hot reload in production)
      - media-files-prod:/app/media
      - static-files-prod:/app/staticfiles
    
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    
    networks:
      - cedrus-frontend
      - cedrus-backend
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
      
      # Restart policy
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
  
  # ============================================================================
  # NGINX REVERSE PROXY
  # ============================================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: cedrus-nginx-prod
    restart: always
    
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/cedrus.conf:/etc/nginx/conf.d/default.conf:ro
      - static-files-prod:/usr/share/nginx/html/static:ro
      - media-files-prod:/usr/share/nginx/html/media:ro
      - nginx-certs:/etc/nginx/certs:ro
      - nginx-logs:/var/log/nginx
    
    ports:
      - "80:80"
      - "443:443"
    
    networks:
      - cedrus-frontend
    
    depends_on:
      - web
    
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /tmp
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
  
  # ============================================================================
  # DATABASE BACKUP SERVICE
  # ============================================================================
  backup:
    image: postgres:16-alpine
    container_name: cedrus-backup-prod
    restart: "no"
    
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-cedrus_prod}
      POSTGRES_USER: ${POSTGRES_USER:-cedrus_prod}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
    
    volumes:
      - postgres-backups:/backups
      - ./docker/postgres/backup.sh:/backup.sh:ro
    
    networks:
      - cedrus-backend
    
    depends_on:
      - postgres
    
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    
    # Run backup script
    entrypoint: ["/bin/sh", "/backup.sh"]
    
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ==============================================================================
# PRODUCTION DEPLOYMENT INSTRUCTIONS
# ==============================================================================
# 1. Create .env.production file with all required secrets:
#      cp .env.example .env.production
#      # Edit .env.production with production values
#
# 2. Build production image:
#      docker-compose -f docker-compose.production.yml build
#
# 3. Run database migrations:
#      docker-compose -f docker-compose.production.yml run --rm web python manage.py migrate
#
# 4. Create superuser:
#      docker-compose -f docker-compose.production.yml run --rm web python manage.py createsuperuser
#
# 5. Collect static files:
#      docker-compose -f docker-compose.production.yml run --rm web python manage.py collectstatic --noinput
#
# 6. Start all services:
#      docker-compose -f docker-compose.production.yml up -d
#
# 7. Check logs:
#      docker-compose -f docker-compose.production.yml logs -f
#
# 8. Setup automated backups (cron):
#      0 2 * * * cd /path/to/cedrus && docker-compose -f docker-compose.production.yml run --rm backup
#
# 9. Monitor services:
#      docker-compose -f docker-compose.production.yml ps
#      docker stats
#
# 10. SSL/TLS Setup:
#       - Place certificates in docker/nginx/certs/
#       - Update nginx configuration with certificate paths
#       - Or use Let's Encrypt with certbot
#
# SECURITY CHECKLIST:
# - [ ] Change all default passwords
# - [ ] Set strong DJANGO_SECRET_KEY (50+ characters)
# - [ ] Configure firewall (allow only 80, 443, SSH)
# - [ ] Enable UFW/iptables
# - [ ] Setup automated backups
# - [ ] Configure log rotation
# - [ ] Enable fail2ban
# - [ ] Regular security updates
# - [ ] Monitor resource usage
# - [ ] Setup alerting
# ==============================================================================
